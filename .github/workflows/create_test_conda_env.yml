name: create_test_conda_env

on: [push]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '>=3.9'

      - name: Add conda to system path
        run: |
          # $CONDA is an env var pointing to root of miniconda dir
          echo $CONDA/bin >> $GITHUB_PATH

      - name: Create fre-workflows environment
        run: |
          # create environment containing all dependencies
          # the env cannot be explicitly activated in github CI/CD
          conda env create -f environment.yml --name fre-workflows

          # add conda env's executables to github's PATH equiv.
          echo $CONDA/envs/fre-workflows/bin >> $GITHUB_PATH

      - name: cylc lint (guarded against failure)
        continue-on-error: true
        run: |
          # lint .cylc workflow files
          cylc lint -v

      - name: Jinja2filter pytest
        run: |
          pytest -v ./Jinja2Filters/tests

      - name: Jinja2filter pylint
        run: |
          pylint -v --fail-under 7.00 ./Jinja2Filters

      - name: make-timeseries pytest (guarded against failure)
        continue-on-error: true
        run: |
          pytest -v -v -rx ./app/make-timeseries/test

      - name: remap-pp-components pytest
        run: |
          cd ./app/remap-pp-components/ && \
            pytest -v -v -rx --cov=./bin/remap-pp-components ./t ;
            cd -

      - name: remap-pp-components pylint
        run: |
          pylint -v --fail-under 9.0 app/remap-pp-components/bin/remap-pp-components

      - name: PPANHandler pytest
        run: |
          pytest -v -v -rx ./lib/python/tests/test_PPANHandler.py

      - name: papiex_tooler pytest
        run: |
          pytest -v -v -rx ./lib/python/tests/test_papiex_tooler.py

      - name: papiex_ops and tool_ops_w_papiex pylint
        run: |
          pylint -v --fail-under 4.50 ./lib/python

      - name: chunkchecker pytest (guarded against failure)
        continue-on-error: true
        run: |
          pytest -v -v -rx ./tests/test_chunkcheck.py

      - name: analysis_validator pytest (guarded against failure)
        continue-on-error: true
        run: |
          pytest -v -v -rx ./tests/test_analysis_validator.py

      - name: python macros pylint
        run: |
          pylint -v --fail-under 4.00 ./meta/lib/python/macros/
