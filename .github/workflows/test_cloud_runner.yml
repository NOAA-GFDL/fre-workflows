name: run_ppp
on: [push]
# cancel running jobs if theres a newer push
#concurrency:
#  group: ${{ github.workflow }}-${{ github.ref }}
#  cancel-in-progress: true

jobs:
  test-cloud:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Run test script
        run: |
          # Print pwd then run script
          echo "Currently in:"
          pwd

          bind_paths="--bind /contrib/container-test/ppp-setup/:/mnt:rw
                      --bind /contrib/container-test/history:/mnt/history:ro
                      --bind /contrib/container-test/grid_spec/c96_OM4_025_grid_No_mg_drag_v20160808.tar:/mnt/c96_OM4_025_grid_No_mg_drag_v20160808.tar
                      --bind /contrib/container-test"

          container_path=/contrib/container-test/ppp_8-22.sif
          runscript_path=./for_gh_runner/runscript.sh

          singularity exec --writable-tmpfs ${bind_paths} ${container_path} ${runscript_path}

        continue-on-error: False

#      - name: Print job.err
#        run: |
#          # Search for if there is an ERR status for any task; if so, add grep output to a list
#          err_out_list=($(grep -r "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/))
#
#          # Check if list of error status is empty or not
#          # If list if empty, workflow may have succeeded (TO-DO: Check for other statuses)
#          # If list is not empty, and ERR status was found -> print the job.err output
#          if [ ${#err_out_list[@]} -eq 0 ]; then
#              echo "CYLC_JOB_EXIT=ERR not found with in any task log."    
#              exit 0
#          else
#              echo "\nEXIT STATUS ERR FOUND"
#              for err in $err_out_list; do
#                  echo "Printing job.err for ${err%/*} ..."
#                  job_err_dir=$(echo "${err%/*}")
#                  cat "${job_err_dir}/job.err"
#              done
#              exit 1
#          fi

      - name: Upload workflow-run log files
        uses: actions/upload-artifact@v4
        with:
          name: fre-workflow-logs 
          path: /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest
          if-no-files-found: error
##To-do:
# - upload job.out/job.err as artifacts
# - figure out if container will be hosted on cloud or somehow pulled from registry
# - examine behavior of runner in draft vs not draft mode
