name: run_ppp
on:
  pull_request:
    branches:
      - main
# cancel running jobs if theres a newer push
#concurrency:
#  group: ${{ github.workflow }}-${{ github.ref }}
#  cancel-in-progress: true

jobs:
  test-cloud:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Run ppp-container
        run: |
          # Print pwd then run script
          echo "Currently in:"
          cwd=$(pwd)
          echo $cwd

          gridspec_file=c96_OM4_025_grid_No_mg_drag_v20160808.tar
          bind_paths="--bind /contrib/container-test/ppp-setup/:/mnt:rw
                      --bind /contrib/container-test/history:/mnt/history:ro
                      --bind /contrib/container-test/grid_spec/${gridspec_file}:/mnt/${gridspec_file}:ro
                      --bind /contrib/container-test"

          container_path=/contrib/container-test/ppp_8-22.sif
          runscript_path=${cwd}/for_gh_runner/runscript.sh

          singularity exec --writable-tmpfs ${bind_paths} ${container_path} ${runscript_path}

          # Can potentially do this to get list of tasks
          #task_list=$(cylc list test_pp__ptest__ttest)
          #task1=$(echo $task_list | cut -d ' ' -f1) ....


      - name: Upload workflow-run log files
        uses: actions/upload-artifact@v4
        with:
          name: fre-workflow-logs
          path: /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log
          if-no-files-found: error

      - name: Print pp-starter successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/pp-starter/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/pp-starter/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/pp-starter/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print stage-history successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/stage-history/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/stage-history/*/job/status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/stage-history/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print regrid-xy successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/regrid-xy*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/regrid-xy*/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/regrid-xy*/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print remap-pp-components successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/remap-pp-components*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/remap-pp-components*/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/remap-pp-components*/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print make-timeavgs successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/make-timeavgs*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/make-timeavgs*/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/make-timeavgs*/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print rename-split-to-pp successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/rename-split-to-pp*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/rename-split-to-pp*/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/rename-split-to-pp*/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print split-netcdf successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/split-netcdf*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/split-netcdf**/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/split-netcdf**/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print combine-timeavgs successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/combine-timeavgs*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/combine-timeavgs*/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/combine-timeavgs*/*/job.status
              exit 1
          fi
          echo "No failures found"

      - name: Print clean task successes or failures
        run: |
          # Successes 
          grep -E "CYLC_JOB_EXIT=SUCCEEDED" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/clean*/*/job.status

          # Failures
          grep -q -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/clean*/*/job.status
          if [ $? -eq 0 ]; then
              grep -E "CYLC_JOB_EXIT=ERR" /contrib/container-test/ppp-setup/cylc-run/test_pp__ptest__ttest/log/job/*/clean*/*/job.status
              exit 1
          fi
          echo "No failures found"


## Keep in here for now as a just in case reference ##
#      - name: Print any succeeded tasks
#        run: |
#          # List tasks that have succeeded (and completed) in the workflow
#          grep -E ":succeeded.*completed" /contrib/container-test/ppp-setup/log.out
#
#      - name: Print any failed tasks
#        run: |
#          # Search for if there is an ERR status for any task
#          if grep -q "failed/ERR" /contrib/container-test/ppp-setup/log.out; then
#              echo "Task failures found: CHECK THE LOG FILES UPLOADED AS ARTIFACTS"
#              grep "failed/ERR" /contrib/container-test/ppp-setup/log.out
#              exit 1
#          fi
#
#          echo "Workflow ran successfully"

##To-do:
# - figure out if container will be hosted on cloud or somehow pulled from registry
# - examine behavior of runner in draft vs not draft mode
