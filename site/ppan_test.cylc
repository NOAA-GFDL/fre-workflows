{% set EPMT_PREAMBLE %}
            export PAPIEX_OLD_OUTPUT=$PAPIEX_OUTPUT
            export PAPIEX_OLD_OPTIONS=$PAPIEX_OPTIONS
            unset PAPIEX_OUTPUT PAPIEX_OPTIONS LD_PRELOAD
{% endset %}
{% set EPMT_POSTAMBLE %}
            export PAPIEX_OPTIONS=$PAPIEX_OLD_OPTIONS
            export LD_PRELOAD=$PAPIEX_LD_PRELOAD
            export PAPIEX_OUTPUT=$PAPIEX_OLD_OUTPUT
{% endset %}


{# see https://cylc.github.io/cylc-doc/stable/html/user-guide/writing-workflows/scheduler.html#scheduler-configuration #}
[scheduler]
    [[events]]
        startup handlers = """
            mkdir -p /xtmp/$USER/work/cylc-run/%(workflow)s/share \
            && mkdir -p /xtmp/$USER/work/cylc-run/%(workflow)s/work
        """
        shutdown handlers = """
            mkdir -p /xtmp/$USER/cleandir/$$/%(workflow)s \
            && mv /xtmp/$USER/work/cylc-run/%(workflow)s/* /xtmp/$USER/cleandir/$$/%(workflow)s
        """

[runtime]
    [[root]]
        init-script = """
            module load epmt
            module list
            epmt check

            module load fre/{{ FRE_VERSION }}
            module load gcp/2.3

            #### if one wants to use their own conda environment, edit the PATH and uncomment below like so:
            #export PATH=/home/$USER/conda/envs/fre-cli/bin:$PATH
        """
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:PLACE_HOLDER;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
        {# retries don't make sense yet while testing as they will just delay the failures #}
        {# execution retry delays = PT1M, PT5M, PT10M                                      #}
        # Set default time limit to 4 hours
        execution time limit = PT4H
        platform = ppan_test
        [[[events]]]
            submission timeout = P1D
        [[[directives]]]
            --comment=xtmp,epmt,fre/{{ FRE_VERSION }}
        [[[environment]]]
            COPY_TOOL=gcp

    [[PP-STARTER]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:pp-starter;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
    [[STAGE-HISTORY]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:stage-history;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """

{% if DO_REFINEDIAG or DO_PREANALYSIS %}
    [[PRE-ANALYSIS]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:analysis;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
        pre-script = """
            env
            set -x
            mkdir -p $work $tempCache $refineDiagDir
            hsmget -v -t -a $histDir -p {{ PTMP_DIR }}/$histDir -w $work $hsmdate/\*
            cd $work/$hsmdate
            ls
        """
{% endif %}

{% if DO_REFINEDIAG %}
    [[REFINE-DIAG]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:refineDiag;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
        post-script = """
            cd $refineDiagDir
            if ls *nc; then
                refinedCount=$(ls -1 *nc | wc -l)
            else
                refinedCount=0
            fi
            if [[ $refinedCount > 0 ]]; then
                for file in $(ls -1 *nc); do
                    list_ncvars.csh -st01234 $file |& tee $CYLC_WORKFLOW_SHARE_DIR/refineDiag.log
                done
            else
                echo ERROR: RefineDiag script did not create any NetCDF files as it was expected to do
                exit 1
            fi
            if [[ -f {{ HISTORY_DIR_REFINED }}/$oname.nc.tar ]]; then
                echo "the contents of {{ PTMP_DIR }}/{{ HISTORY_DIR_REFINED }} is..."
                ls {{ PTMP_DIR }}/{{ HISTORY_DIR_REFINED }}
                echo "the contents of {{ PTMP_DIR }}/{{ HISTORY_DIR_REFINED }}/$oname.nc is..."
                ls {{ PTMP_DIR }}/{{ HISTORY_DIR_REFINED }}/$oname.nc
                hsmget -v -t -a {{ HISTORY_DIR_REFINED }} -p {{ PTMP_DIR }}/{{ HISTORY_DIR_REFINED }} \
                    -w $TMPDIR/modify_refineDiag $hsmdate/\*
                mv -f * $TMPDIR/modify_refineDiag
                mv -f $TMPDIR/modify_refineDiag/* .
                rm -rf $TMPDIR/modify_refineDiag
            fi
            hsmput -v -t -s tar -a {{ HISTORY_DIR_REFINED }} -p {{ PTMP_DIR }}/{{ HISTORY_DIR_REFINED }} \
                -w $TMPDIR/history_refineDiag $hsmdate
        """
{% endif %}

    [[RENAME-SPLIT-TO-PP]]
        pre-script = module load netcdf-c cdo nco

    [[DATA-CATALOG]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:data-catalog;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """

    [[MAKE-TIMEAVGS]]
        pre-script = module load cdo

    [[MAKE-TIMESERIES]]
        pre-script = module load cdo

    [[COMBINE-TIMEAVGS]]
        pre-script = module load cdo nco

{% if DO_REGRID %}
    [[REGRID-XY]]
        execution time limit = P1D
        pre-script = """
            module load fre-nctools/2024.05.01
            which fregrid
        """
{% endif %}

    [[CLEAN]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:clean;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """

{% if DO_REGRID_STATIC or DO_NATIVE_STATIC %}
    [[combine-statics]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:combine-statics;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
        pre-script = mkdir -p $outputDir
{% endif %}

    [[ANALYSIS]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:analysis;\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """

{% set PP_COMPONENTS_LIST = PP_COMPONENTS.split(' ') %}
{% for COMPONENT in PP_COMPONENTS_LIST %}
    [[<component={{ COMPONENT }}>]]
        env-script = """
    {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:{{ COMPONENT }};\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
    {{ EPMT_POSTAMBLE }}
        """
{% endfor %}




{% if DO_REGRID %}
    {% set REGRID_LIST = REGRID.split(', ') %}
    {% for REGRID_COMP in REGRID_LIST %}
    [[<regrid={{ REGRID_COMP }}>]]
        env-script = """
        {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:{{ REGRID_COMP }};\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
        {{ EPMT_POSTAMBLE }}
        """
    {% endfor %}

    {% if DO_REGRID_STATIC %}
        {% set REGRID_STATIC_LIST = REGRID_STATIC.split(', ') %}
        {% for REGRID_STATIC_COMP in REGRID_STATIC_LIST %}
    [[<regrid_static={{ REGRID_STATIC_COMP }}>]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:{{ REGRID_STATIC_COMP }};\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
        {% endfor %}
    {% endif %}
{% endif %}

{% if DO_NATIVE %}
    {% set NATIVE_LIST = NATIVE.split(', ') %}
    {% for NATIVE_COMP in NATIVE_LIST %}
    [[<native={{ NATIVE_COMP }}>]]
        env-script = """
        {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:{{ NATIVE_COMP }};\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
        {{ EPMT_POSTAMBLE }}
        """
    {% endfor %}
    {% if DO_NATIVE_STATIC %}
        {% set NATIVE_STATIC_LIST = NATIVE_STATIC.split(', ') %}
        {% for NATIVE_STATIC_COMP in NATIVE_STATIC_LIST %}
    [[<native_static={{ NATIVE_STATIC_COMP }}>]]
        env-script = """
            {{ EPMT_PREAMBLE }}
            epmt annotate EPMT_JOB_TAGS="exp_name:{{ EXPERIMENT }};exp_fre_mod:{{ FRE_VERSION }};exp_platform:{{ PLATFORM }};\
                exp_target:{{ TARGET }};exp_component:{{ NATIVE_STATIC_COMP }};\
                exp_time:$CYLC_TASK_CYCLE_POINT;exp_seg_months:{{ HISTORY_SEGMENT }};\
                script_name:$CYLC_TASK_NAME;exp_run_uuid:$CYLC_WORKFLOW_UUID"
            {{ EPMT_POSTAMBLE }}
        """
        {% endfor %}
    {% endif %}
{% endif %}
